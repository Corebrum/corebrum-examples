task_definition:
  name: "simple_qwen_test"
  version: "1.0"
  description: "Simple one-shot test to verify Qwen person detection works"

  execution_mode: "one_shot"

  compute_logic:
    type: "script"
    language: "python"
    timeout_seconds: 30
    code: |
      import cv2
      import numpy as np
      import logging
      import time
      import requests
      import base64

      logging.basicConfig(level=logging.INFO)
      logger = logging.getLogger(__name__)

      def detect_person_with_qwen(image):
          """Use Qwen to detect if there's a person in the image"""
          try:
              resized_image = cv2.resize(image, (160, 90))
              _, buffer = cv2.imencode('.jpg', resized_image, [cv2.IMWRITE_JPEG_QUALITY, 85])
              image_base64 = base64.b64encode(buffer).decode('utf-8')
              
              payload = {
                  "model": "qwen2.5vl:3b",
                  "prompt": "Look at this image carefully. Is there a person (a man, woman, or person) clearly visible in this image? Answer only 'yes' or 'no'. Be very strict - only say 'yes' if you can clearly see a complete person.",
                  "images": [image_base64],
                  "stream": False
              }
              
              logger.info("ü§ñ Sending image to Qwen for person detection...")
              response = requests.post(
                  "http://localhost:11434/api/generate",
                  json=payload,
                  timeout=15
              )
              
              if response.status_code == 200:
                  result = response.json()
                  answer = result.get('response', 'no').strip().lower()
                  person_detected = 'yes' in answer or 'person' in answer
                  logger.info(f"üéØ Qwen Person Detection: {answer} -> {person_detected}")
                  return person_detected, answer
              else:
                  logger.error(f"Ollama API error: {response.status_code} - {response.text}")
                  return False, "API error"
          except Exception as e:
              logger.error(f"Error detecting person with Qwen: {e}")
              return False, str(e)

      # Main processing
      logger.info("üöÄ Starting simple Qwen person detection test...")
      
      try:
          logger.info("üì∏ Capturing image from camera...")
          cap = cv2.VideoCapture(0)
          
          if not cap.isOpened():
              logger.error("Could not open camera")
              result = {"status": "error", "message": "Could not open camera"}
          else:
              cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
              cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
              
              ret, frame = cap.read()
              cap.release()
              
              if not ret:
                  logger.error("Could not capture frame from camera")
                  result = {"status": "error", "message": "Could not capture frame"}
              else:
                  logger.info(f"üì∏ Captured image: {frame.shape[1]}x{frame.shape[0]} pixels")
                  filename = f"/tmp/simple_qwen_test_{int(time.time())}.jpg"
                  cv2.imwrite(filename, frame)
                  logger.info(f"üíæ Image saved to: {filename}")
                  
                  person_detected, qwen_answer = detect_person_with_qwen(frame)
                  
                  result = {
                      "status": "success",
                      "person_detected": person_detected,
                      "qwen_answer": qwen_answer,
                      "image_file": filename,
                      "message": "Simple Qwen person detection test completed successfully"
                  }
                  
                  logger.info("‚úÖ Simple Qwen person detection test completed!")
                  logger.info(f"ü§ñ Person detected: {person_detected}")
                  logger.info(f"üìù Qwen says: {qwen_answer}")
      
      except Exception as e:
          logger.error(f"Error in simple Qwen test: {e}")
          result = {
              "status": "error",
              "message": str(e)
          }
