task_definition:
  name: "camera_publisher"
  version: "1.0"
  description: "Publishes camera data to zenoh topic for person following"
  
  execution_mode: "stream_reactive"
  stream_config:
    trigger: "time_interval"
    rate_limit_hz: 2  # Publish 2 images per second
    buffer_size: 1
  
  outputs:
    - name: "camera_image"
      type: "zenoh_topic"
      key_expr: "rt/camera/camera/color/image_raw"
      encoding: "raw"
  
  compute_logic:
    type: "script"
    language: "python"
    timeout_seconds: 30
    code: |
      import cv2
      import numpy as np
      import logging
      import time
      import struct
      
      # Configure logging
      logging.basicConfig(level=logging.INFO)
      logger = logging.getLogger(__name__)
      
      def create_ros2_image_message(image):
          """Create a proper ROS2 sensor_msgs/Image message in binary format"""
          try:
              # Convert BGR to RGB for ROS2
              image_rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
              height, width = image_rgb.shape[:2]
              
              # Create the message structure
              # Header (stamp + frame_id)
              header = struct.pack('<II', 0, 0)  # stamp.sec, stamp.nanosec
              frame_id = b'camera'
              frame_id_len = len(frame_id)
              header += struct.pack('<I', frame_id_len) + frame_id
              
              # Image info
              height_bytes = struct.pack('<I', height)
              width_bytes = struct.pack('<I', width)
              encoding = b'rgb8'
              is_bigendian = struct.pack('<B', 0)
              step = struct.pack('<I', width * 3)
              
              # Image data
              image_data = image_rgb.tobytes()
              
              # Combine all parts
              message = header + height_bytes + width_bytes + encoding + is_bigendian + step + image_data
              
              return message
              
          except Exception as e:
              logger.error(f"Error creating ROS2 image message: {e}")
              return None
      
      # Main processing
      logger.info("ðŸ“¸ Capturing camera image...")
      
      try:
          # Try to open the default camera
          cap = cv2.VideoCapture(0)
          
          if not cap.isOpened():
              logger.error("Could not open camera")
              ros2_message = b''
          else:
              # Set camera properties
              cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
              cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)
              
              # Capture frame
              ret, frame = cap.read()
              cap.release()
              
              if not ret:
                  logger.error("Could not capture frame from camera")
                  ros2_message = b''
              else:
                  logger.info(f"ðŸ“¸ Captured image: {frame.shape[1]}x{frame.shape[0]} pixels")
                  
                  # Create ROS2 message
                  ros2_message = create_ros2_image_message(frame)
                  
                  if ros2_message is None:
                      logger.error("Failed to create ROS2 message")
                      ros2_message = b''
                  else:
                      logger.info(f"ðŸ“¤ Publishing ROS2 image message: {len(ros2_message)} bytes")
      
      except Exception as e:
          logger.error(f"Error capturing camera image: {e}")
          ros2_message = b''
      
      # Return result
      result = {
          "camera_image": ros2_message
      }
  
  validation: []
  metadata:
    publisher: "camera"
    description: "Publishes camera data to zenoh for person following"
